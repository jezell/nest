name: 'Apply Patches'
description: 'Checkout flock into the path "flock" and then apply the patches'
inputs:
  flutter_ref:
    required: true
    description: "the ref of the flutter repo to use as a base"

  flutter_repo:
    required: false
    description: "the flutter repo to use as a base"
    default: flutter/flutter

  token: 
    required: false
    description: "access token"
    default: ${{ github.token }}

  email:
    required: false
    default: "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
    description: "the committer email"

  user_name:
    required: false
    description: "the committer name"
    default: "${{ github.actor }}"

  fetch_depth:
    required: false
    default: 1

runs:
  using: "composite"
  steps:
    - name: checkout base flutter ref
      uses: actions/checkout@v4
      with:
        path: 'flock'
        repository: ${{inputs.flutter_repo}}
        ref: '${{inputs.flutter_ref}}'
        token: ${{ inputs.token }}
    
    # Compute an engine version hash so the flutter tool will be able to find a precompiled engine
    - name: save engine hash
      shell: bash
      run: |
        ./flock/bin/internal/update_engine_version.sh
        cp ./flock/bin/cache/engine.stamp ./flock/bin/internal/engine.version
        git add ./flock/bin/internal/engine.version
    
    - name: apply nest patches to flutter
      shell: bash
      run: |
        git config --global user.email "${{ inputs.email }}"
        git config --global user.name "${{ inputs.user_name }}"
        tools/git-import-patches patches